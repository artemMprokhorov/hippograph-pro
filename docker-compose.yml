services:
  hippograph:
    build: .
    container_name: hippograph
    ports:
      - "5001:5000"  # API server
      - "5002:5002"  # Web viewer
    volumes:
      - ./data:/app/data
      - ./src:/app/src
      - ./web:/var/www/html
    environment:
      - DB_PATH=/app/data/memory.db
      - FLASK_PORT=5000
      - FLASK_DEBUG=false
      - MCP_ENDPOINT=/sse
      - ENABLE_EMOTIONAL_MEMORY=false
      - NEURAL_API_KEY=${NEURAL_API_KEY:-change_me_in_production}
      - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN}
      - ACTIVATION_ITERATIONS=3
      - ACTIVATION_DECAY=0.7
      - SIMILARITY_THRESHOLD=0.5
      - HALF_LIFE_DAYS=30
      # Entity extraction: gliner (recommended) | spacy | regex
      - ENTITY_EXTRACTOR=${ENTITY_EXTRACTOR:-gliner}
      - GLINER_MODEL=${GLINER_MODEL:-urchade/gliner_multi-v2.1}
      - GLINER_THRESHOLD=${GLINER_THRESHOLD:-0.4}
      # GLiNER2: relation extraction in sleep_compute (Deep Sleep phase)
      - GLINER2_MODEL=${GLINER2_MODEL:-fastino/gliner2-large-v1}
      - GLINER2_THRESHOLD=${GLINER2_THRESHOLD:-0.3}
      - EMBEDDING_MODEL=sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2
      - BLEND_ALPHA=0.7
      - USE_ANN_INDEX=true
      - ANN_INDEX_TYPE=HNSW
      - HNSW_M=32
      - HNSW_EF_CONSTRUCTION=64
      - HNSW_EF_SEARCH=32
      # Fusion method: blend (weighted) or rrf (rank-based)
      - FUSION_METHOD=${FUSION_METHOD:-blend}
      # Sleep-Time Compute auto-trigger
      # SLEEP_INTERVAL_HOURS: run sleep_compute every N hours (0 = disabled)
      - SLEEP_INTERVAL_HOURS=${SLEEP_INTERVAL_HOURS:-6}
      # SLEEP_NOTE_THRESHOLD: also trigger after N new notes added (0 = disabled)
      - SLEEP_NOTE_THRESHOLD=${SLEEP_NOTE_THRESHOLD:-50}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
