services:
  hippograph:
    build: .
    container_name: hippograph
    ports:
      - "5001:5000"  # API server
      - "5002:5002"  # Web viewer
    volumes:
      - ./data:/app/data
      - ./src:/app/src
      - ./web:/var/www/html
    environment:
      - DB_PATH=/app/data/memory.db
      - FLASK_PORT=5000
      - FLASK_DEBUG=false
      - MCP_ENDPOINT=/sse
      - ENABLE_EMOTIONAL_MEMORY=false
      - NEURAL_API_KEY=${NEURAL_API_KEY:-change_me_in_production}
      - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN}
      - ACTIVATION_ITERATIONS=3
      - ACTIVATION_DECAY=0.7
      - SIMILARITY_THRESHOLD=0.5
      - HALF_LIFE_DAYS=30
      # Entity extraction: gliner (recommended) | ollama | spacy | regex
      - ENTITY_EXTRACTOR=${ENTITY_EXTRACTOR:-spacy}
      - GLINER_MODEL=${GLINER_MODEL:-urchade/gliner_multi-v2.1}
      - GLINER_THRESHOLD=${GLINER_THRESHOLD:-0.4}
      - EMBEDDING_MODEL=sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2
      - BLEND_ALPHA=0.7
      - USE_ANN_INDEX=true
      - ANN_INDEX_TYPE=HNSW
      - HNSW_M=32
      - HNSW_EF_CONSTRUCTION=64
      - HNSW_EF_SEARCH=32
      # Ollama integration (optional)
      - OLLAMA_URL=${OLLAMA_URL:-http://hippograph-ollama:11434}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-qwen2.5:7b}
      # Fusion method: blend (weighted) or rrf (rank-based)
      - FUSION_METHOD=${FUSION_METHOD:-blend}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      ollama:
        condition: service_started
        required: false

  ollama:
    image: ollama/ollama:latest
    container_name: hippograph-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/version"]
      interval: 30s
      timeout: 10s
      retries: 3
    profiles:
      - ollama

volumes:
  ollama_data:
